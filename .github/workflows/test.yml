name: Build and Test
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]
    branches-ignore:
      - '!l10n_master'
jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 11
        run: |
           sudo apt-get -q -y install default-jdk
#         apt-get -q -y install libservlet3.1-java tomcat9
#        uses: actions/setup-java@v1
#        with:
#          java-version: 11
      - name: Cache Maven packages
        uses: actions/cache@v1
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Setup Tomcat
        run: |
          sudo chmod 755 /home/runner/work/ctsms/ctsms/.github/workflows/setup_tomcat.sh
          sudo /home/runner/work/ctsms/ctsms/.github/workflows/setup_tomcat.sh  
      - name: Setup Selenium
        run: |
          sudo chmod 755 /home/runner/work/ctsms/ctsms/.github/workflows/setup_selenium.sh
          sudo /home/runner/work/ctsms/ctsms/.github/workflows/setup_selenium.sh
          xvfb-run java -Dwebdriver.chrome.driver=/usr/bin/chromedriver -jar selenium-server-standalone-3.141.59.jar 2>&1 &
          
#      - name: test perl selenium remote
#        run: |
#          
#          xvfb-run java -Dwebdriver.chrome.driver=/usr/bin/chromedriver -jar selenium-server-standalone-3.141.59.jar 2>&1 &
#          perl /home/runner/work/ctsms/ctsms/.github/workflows/seleniumtest.pl
          
      - name: test java selenium remote
        run: |
        
          sudo chmod 755 /home/runner/work/ctsms/ctsms/.github/workflows/run_selenium_test.sh
          /home/runner/work/ctsms/ctsms/.github/workflows/run_selenium_test.sh org.phoenixctms.ctsms.selenium.testChrome 

      - name: Run testsuite
        run: |
          sudo -u ctsms /home/runner/work/ctsms/ctsms/.github/workflows/dbtool.sh -ldd -f -er git@phoenixctms.org
